"use client";

import React, { useState, useEffect, useCallback } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { cn } from '@/lib/utils';
import HexMap from './map-management/HexMap';
import ResearchPanel from './research-management/ResearchPanel';
import gameService from '@/services/gameService';
import { useToast } from './ui/useToast';
import { Send, Clock } from 'lucide-react';
import TurnManager, { TurnPhase } from './TurnManager';

interface LogEntry {
  type: 'system' | 'advisor' | 'event' | 'player';
  content: string;
  turn: number;
}

export default function GamePage() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [gameId, setGameId] = useState<string>('');
  const [userId, setUserId] = useState<string>('default-user-id');
  const [turn, setTurn] = useState<number>(1);
  const [phase, setPhase] = useState<TurnPhase>('player');
  
  // ë¡œê·¸ ê´€ë ¨ ìƒíƒœ
  const [log, setLog] = useState<LogEntry[]>([]);
  const [commandInput, setCommandInput] = useState<string>('');
  
  // í† ìŠ¤íŠ¸ ê´€ë ¨ ì½”ë“œ
  const { showToast, ToastContainer } = useToast();
  
  // íƒ­ ê´€ë ¨ ì½”ë“œ
  const tabs = [
    { id: 'map', label: 'ë§µ', icon: 'ğŸŒ' },
    { id: 'research', label: 'ì—°êµ¬', icon: 'ğŸ”¬' },
    { id: 'city', label: 'ë„ì‹œ', icon: 'ğŸ™ï¸' },
    { id: 'diplomacy', label: 'ì™¸êµ', icon: 'ğŸ¤' },
    { id: 'culture', label: 'ë¬¸í™”', icon: 'ğŸ­' },
  ];
  
  // í˜„ì¬ ì„ íƒëœ íƒ­ ìƒíƒœ ê´€ë¦¬
  const [activeTab, setActiveTab] = useState('map');

  // ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ ê²Œì„ ID ë° ìœ ì € ID í™•ì¸
  useEffect(() => {
    // URL íŒŒë¼ë¯¸í„°ì—ì„œ userId í™•ì¸
    const urlUserId = searchParams.get('userId');
    
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì ‘ê·¼ì€ í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œì—ì„œë§Œ ê°€ëŠ¥
    const storedUserId = typeof window !== 'undefined' ? localStorage.getItem('userId') : null;
    const finalUserId = urlUserId || storedUserId || 'default-user-id';
    
    // ìœ ì € ID ì„¤ì • ë° ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
    setUserId(finalUserId);
    if (typeof window !== 'undefined') {
      localStorage.setItem('userId', finalUserId);
    }
    
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ê²Œì„ ID í™•ì¸
    const storedGameId = typeof window !== 'undefined' ? localStorage.getItem('text_civ_game_id') : null;
    
    if (storedGameId) {
      setGameId(storedGameId);
      setIsLoading(false);
      
      // ì´ˆê¸° ë¡œê·¸ ë©”ì‹œì§€ ì¶”ê°€
      addLog('system', 'ê²Œì„ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', turn);
      addLog('advisor', 'ë¬¸ëª…ì˜ ì§€ë„ìë‹˜, í™˜ì˜í•©ë‹ˆë‹¤! ë‹¹ì‹ ì˜ ë¬¸ëª…ì„ ì´ëŒì–´ ìŠ¹ë¦¬í•˜ì„¸ìš”.', turn);
    } else {
      // ê²Œì„ IDê°€ ì—†ìœ¼ë©´ ê²Œì„ ì„ íƒ í˜ì´ì§€ë¡œ ì´ë™
      showToast({
        title: "ê²Œì„ ì„¸ì…˜ ì—†ìŒ",
        description: "ì§„í–‰ ì¤‘ì¸ ê²Œì„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒˆ ê²Œì„ì„ ì‹œì‘í•´ì£¼ì„¸ìš”.",
        variant: "destructive"
      });
      
      // ì§§ì€ ì§€ì—° í›„ ë¦¬ë‹¤ì´ë ‰íŠ¸
      setTimeout(() => {
        router.push('/game/select-mode');
      }, 2000);
    }
  }, [router, showToast, searchParams]);

  // ê²Œì„ ë¡œê·¸ ì¶”ê°€
  const addLog = useCallback((type: LogEntry['type'], content: string, currentTurn: number) => {
    setLog(prev => [...prev, { type, content, turn: currentTurn }]);
  }, []);

  // í„´ ì¢…ë£Œ ì²˜ë¦¬
  const endTurn = useCallback(async () => {
    try {
      setPhase('resolve');
      addLog('system', `í„´ ${turn} ì¢…ë£Œ! AI ì²˜ë¦¬ ì¤‘...`, turn);
      showToast({
        title: "í„´ ì¢…ë£Œ",
        description: `í„´ ${turn} ì¢…ë£Œ! AI ì²˜ë¦¬ ì¤‘...`,
        variant: "default"
      });
      
      // TODO: í„´ ì¢…ë£Œ API í˜¸ì¶œ ë° ì´ë²¤íŠ¸ ì²˜ë¦¬
      // ì„ì‹œë¡œ 1ì´ˆ í›„ì— ë‹¤ìŒ í„´ìœ¼ë¡œ ë„˜ì–´ê°€ëŠ” ì½”ë“œ
      setTimeout(() => {
        setTurn(prev => prev + 1);
        setPhase('player');
        addLog('system', `í„´ ${turn + 1} ì‹œì‘`, turn + 1);
        showToast({
          title: "í„´ ì‹œì‘",
          description: `í„´ ${turn + 1} ì‹œì‘`,
          variant: "default"
        });
      }, 1000);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'í„´ ì²˜ë¦¬ ì‹¤íŒ¨');
      showToast({
        title: "ì˜¤ë¥˜",
        description: 'í„´ ì²˜ë¦¬ ì‹¤íŒ¨',
        variant: "destructive"
      });
      setPhase('player');
    }
  }, [turn, addLog, showToast]);

  // ëª…ë ¹ì–´ ì…ë ¥ ì²˜ë¦¬
  const handleCommand = (e: React.FormEvent) => {
    e.preventDefault();
    if (!commandInput.trim()) return;
    
    // ëª…ë ¹ì–´ ì²˜ë¦¬ ë¡œì§
    addLog('player', commandInput, turn);
    
    // ëª…ë ¹ì–´ì— ë”°ë¥¸ ì²˜ë¦¬ (ê°„ë‹¨í•œ ì˜ˆì‹œ)
    if (commandInput.toLowerCase().includes('í„´ ì¢…ë£Œ')) {
      endTurn();
    } else if (commandInput.toLowerCase().includes('ë„ì›€ë§')) {
      addLog('system', 'ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´: í„´ ì¢…ë£Œ, ë„ì›€ë§, ìƒíƒœ, ì •ë³´', turn);
    } else if (commandInput.toLowerCase().includes('ìƒíƒœ')) {
      addLog('system', `í˜„ì¬ í„´: ${turn}, ë‹¨ê³„: ${phase}`, turn);
    } else {
      addLog('system', 'ì¸ì‹í•  ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´ì…ë‹ˆë‹¤. "ë„ì›€ë§"ì„ ì…ë ¥í•˜ì—¬ ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´ë¥¼ í™•ì¸í•˜ì„¸ìš”.', turn);
    }
    
    setCommandInput('');
  };

  // í˜„ì¬ ì„ íƒëœ íƒ­ì— ë”°ë¥¸ ì»´í¬ë„ŒíŠ¸ ë Œë”ë§
  const renderTabContent = () => {
    if (isLoading) {
      return <div className="flex items-center justify-center h-full">ë¡œë”© ì¤‘...</div>;
    }
    
    if (error) {
      return (
        <div className="flex flex-col items-center justify-center h-full">
          <div className="text-red-500 mb-4">{error}</div>
          <button
            className="px-4 py-2 bg-blue-600 rounded hover:bg-blue-700"
            onClick={() => router.push('/game/select-mode')}
          >
            ê²Œì„ ì„ íƒ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°
          </button>
        </div>
      );
    }
    
    switch (activeTab) {
      case 'map':
        return <HexMap gameId={gameId} userId={userId} />;
      case 'research':
        return <ResearchPanel gameId={gameId} userId={userId} />;
      case 'city':
        return <div className="p-4">ë„ì‹œ ê´€ë¦¬ íŒ¨ë„ (ê°œë°œ ì¤‘)</div>;
      case 'diplomacy':
        return <div className="p-4">ì™¸êµ íŒ¨ë„ (ê°œë°œ ì¤‘)</div>;
      case 'culture':
        return <div className="p-4">ë¬¸í™” íŒ¨ë„ (ê°œë°œ ì¤‘)</div>;
      default:
        return <div className="p-4">íƒ­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>;
    }
  };

  return (
    <div className="h-screen w-screen flex flex-col bg-slate-900 text-white">
      {/* ìƒë‹¨ í—¤ë” */}
      <header className="h-12 bg-slate-800 border-b border-slate-700 flex items-center px-4 justify-between">
        <h1 className="font-bold">Text Civilization</h1>
        <div className="flex items-center space-x-4">
          <div className="flex items-center mr-4">
            <Clock className="mr-1 text-blue-400" size={16} />
            <span className="font-bold">í„´: {turn}</span>
          </div>
          <button 
            className="px-2 py-1 bg-red-700 hover:bg-red-800 rounded text-sm"
            onClick={() => {
              gameService.endGameSession();
              router.push('/game/select-mode');
            }}
          >
            ê²Œì„ ì¢…ë£Œ
          </button>
        </div>
      </header>
      
      {/* ë©”ì¸ ì»¨í…ì¸  */}
      <div className="flex-1 flex flex-col overflow-hidden">
        <div className="flex-1 flex overflow-hidden">
          {/* ì™¼ìª½ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */}
          <div className="w-16 bg-slate-800 border-r border-slate-700 flex flex-col items-center py-4">
            {tabs.map((tab) => (
              <button
                key={tab.id}
                className={cn(
                  "w-12 h-12 mb-4 rounded-lg flex items-center justify-center",
                  activeTab === tab.id ? 'bg-indigo-600' : 'bg-slate-700 hover:bg-slate-600'
                )}
                onClick={() => setActiveTab(tab.id)}
                title={tab.label}
              >
                <span className="text-xl">{tab.icon}</span>
              </button>
            ))}
          </div>
          
          {/* ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ */}
          <div className="flex-1 overflow-hidden">
            {renderTabContent()}
          </div>
        </div>
        
        {/* í•˜ë‹¨ ë¡œê·¸ ë° ëª…ë ¹ ì˜ì—­ */}
        <div className="h-[25vh] bg-slate-800 border-t border-slate-700 flex">
          {/* ë¡œê·¸ ì˜ì—­ */}
          <div className="flex-1 p-3 overflow-auto flex flex-col-reverse">
            <div className="space-y-3">
              {log.slice().reverse().map((entry: LogEntry, idx: number) => (
                <div key={idx} className={cn(
                  "p-2 rounded",
                  entry.type === 'system' ? 'bg-slate-700 text-gray-300' :
                  entry.type === 'advisor' ? 'bg-indigo-900' :
                  entry.type === 'event' ? 'bg-amber-900' : 'bg-slate-600'
                )}>
                  <div className="flex items-start">
                    <div className="text-sm">
                      {entry.type === 'system' && <span className="font-bold text-xs mr-1">[ì‹œìŠ¤í…œ]</span>}
                      {entry.type === 'advisor' && <span className="font-bold text-xs mr-1">[ì¡°ì–¸ì]</span>}
                      {entry.type === 'event' && <span className="font-bold text-xs mr-1">[ì´ë²¤íŠ¸]</span>}
                      {entry.type === 'player' && <span className="font-bold text-xs mr-1">[ëª…ë ¹]</span>}
                      {entry.content}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
          
          {/* ëª…ë ¹ ì…ë ¥ ì˜ì—­ */}
          <div className="w-1/3 border-l border-slate-700 p-3 flex flex-col">
            <div className="flex-1 overflow-auto mb-3">
              <h4 className="font-bold mb-2">ëª…ë ¹ì–´ ë„ì›€ë§</h4>
              <div className="text-sm space-y-1 text-gray-300">
                <p>- í„´ ì¢…ë£Œ: í˜„ì¬ í„´ì„ ì¢…ë£Œí•˜ê³  ë‹¤ìŒ í„´ìœ¼ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.</p>
                <p>- ë„ì›€ë§: ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.</p>
                <p>- ìƒíƒœ: í˜„ì¬ ê²Œì„ ìƒíƒœë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.</p>
              </div>
            </div>
            
            {/* ëª…ë ¹ ì…ë ¥ */}
            <form onSubmit={handleCommand} className="flex">
              <input
                type="text"
                value={commandInput}
                onChange={(e) => setCommandInput(e.target.value)}
                placeholder="ëª…ë ¹ì„ ì…ë ¥í•˜ì„¸ìš”..."
                className="flex-1 bg-slate-700 rounded-l p-2 focus:outline-none"
              />
              <button 
                type="submit"
                className="bg-indigo-600 hover:bg-indigo-700 px-4 rounded-r flex items-center"
              >
                <Send size={16} />
              </button>
            </form>
          </div>
        </div>
      </div>
      
      {/* í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ */}
      <ToastContainer />
    </div>
  );
}